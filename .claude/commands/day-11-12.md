# Day 11-12: Entity Palette & State Management Implementation

## Objective
Complete Phase 1 remaining features: entity palette UI, Zustand state management, and auto-save mechanism.

## Context
Day 9-10 delivered:
- âœ… Core services (layout, storage, Claude API)
- âœ… DiagramCanvas and EntityNode components
- âœ… PostHog tracking infrastructure
- âœ… TypeScript strict mode (100% coverage)

**Still Needed for Phase 1:**
- [ ] Entity palette UI (click to add nodes)
- [ ] Zustand store (centralized state)
- [ ] Auto-save mechanism (30s interval)

## Implementation Tasks

### Task 1: Entity Palette Component (~150 lines)

**Create:** `src/components/Canvas/ToolPanel.tsx`

**Requirements:**
```typescript
interface ToolPanelProps {
  onAddNode: (type: EntityType) => void;
}

// 8 entity types to display:
// - Corporation, LLC, Partnership, Individual
// - Trust, Disregarded Entity, Foreign Entity, Asset

// Features:
// - Click entity type â†’ adds to canvas
// - Visual preview of each entity type
// - Hover states with descriptions
// - Position: Left sidebar or top toolbar
```

**Design:**
- Icon or colored box for each entity type
- Tooltip showing entity description
- Professional styling (Tailwind)
- Responsive (collapse on small screens)

**Integration:**
- Import in DiagramCanvas
- Pass callback to add nodes at center position
- Use React Flow's `addNodes` API

**Test Selector:**
```typescript
data-testid="tool-panel"
data-testid="add-entity-{type}"  // e.g., add-entity-corporation
```

---

### Task 2: Zustand Store (~200 lines)

**Create:** `src/hooks/useDiagramState.ts`

**Requirements:**
```typescript
interface DiagramState {
  // State
  nodes: Node[];
  edges: Edge[];
  selectedNodeId: string | null;
  isDirty: boolean;
  lastSaved: Date | null;

  // Actions
  setNodes: (nodes: Node[]) => void;
  setEdges: (edges: Edge[]) => void;
  addNode: (type: EntityType, position: { x: number; y: number }) => void;
  updateNode: (id: string, data: Partial<EntityNodeData>) => void;
  deleteNode: (id: string) => void;
  selectNode: (id: string | null) => void;

  // Persistence
  saveDiagram: () => Promise<void>;
  loadDiagram: (id: string) => Promise<void>;
  markClean: () => void;

  // Undo/Redo (optional for Day 11-12)
  undo: () => void;
  redo: () => void;
}
```

**Features:**
- Zustand store with persist middleware
- LocalStorage integration via storage service
- Dirty flag tracking (unsaved changes)
- PostHog event tracking on state changes

**Migration:**
- Replace React Flow's `useNodesState` and `useEdgesState`
- Centralize state in DiagramCanvas
- Add undo/redo capability (optional)

---

### Task 3: Auto-Save Hook (~100 lines)

**Create:** `src/hooks/useAutoSave.ts`

**Requirements:**
```typescript
interface AutoSaveOptions {
  interval?: number;  // Default: 30000 (30 seconds)
  enabled?: boolean;  // Default: true
}

function useAutoSave(options?: AutoSaveOptions) {
  // Auto-save logic
  // - Trigger save every 30s if diagram is dirty
  // - Debounce rapid changes
  // - Show "Saving..." / "Saved" indicator
  // - Track with PostHog
}
```

**Features:**
- 30-second interval (configurable)
- Only save if `isDirty === true`
- Debounce: Wait 2s after last change before saving
- Visual feedback (toast or status indicator)
- Error handling (retry on failure)
- PostHog tracking:
  - `autosave_success`
  - `autosave_failed`

**Integration:**
- Call in DiagramCanvas component
- Use Zustand store's `saveDiagram` action
- Display save status in UI

---

### Task 4: Update DiagramCanvas (~50 lines changes)

**File:** `src/components/Canvas/DiagramCanvas.tsx`

**Changes:**
1. Import and use Zustand store instead of local state
2. Add ToolPanel component to layout
3. Integrate useAutoSave hook
4. Add save status indicator

```typescript
import { useDiagramState } from '@/hooks/useDiagramState';
import { useAutoSave } from '@/hooks/useAutoSave';
import { ToolPanel } from './ToolPanel';

export function DiagramCanvas() {
  const { nodes, edges, addNode, setNodes, setEdges } = useDiagramState();
  const { isSaving, lastSaved } = useAutoSave();

  const handleAddNode = (type: EntityType) => {
    // Add node at viewport center
    const centerX = window.innerWidth / 2;
    const centerY = window.innerHeight / 2;
    addNode(type, { x: centerX, y: centerY });
  };

  return (
    <div className="flex h-full">
      <ToolPanel onAddNode={handleAddNode} />
      <div className="flex-1">
        <ReactFlow nodes={nodes} edges={edges} {...} />
        {isSaving && <SaveIndicator />}
      </div>
    </div>
  );
}
```

---

### Task 5: Save Status Indicator (~50 lines)

**Create:** `src/components/Canvas/SaveIndicator.tsx`

**Requirements:**
- Display save status: "Saving...", "Saved X seconds ago", "Error"
- Position: Top-right corner or bottom-right
- Auto-hide after 3 seconds of "Saved" state
- Red indicator for errors

---

## Testing Requirements

### Manual Testing
1. **Entity Palette:**
   - Click each entity type â†’ node appears on canvas
   - Verify 8 entity types all work
   - Test positioning (should appear at viewport center)

2. **State Management:**
   - Add multiple nodes â†’ verify state updates
   - Delete node â†’ verify state updates
   - Reload page â†’ verify persistence

3. **Auto-Save:**
   - Add node â†’ wait 30s â†’ verify save indicator
   - Make rapid changes â†’ verify debouncing works
   - Check localStorage â†’ verify data saved

### Integration Tests
Add to `tests/integration/DiagramCanvas.test.tsx`:
```typescript
test('should add node when entity type clicked in palette', async () => {
  render(<DiagramCanvas />);

  const addCorporationBtn = screen.getByTestId('add-entity-corporation');
  await userEvent.click(addCorporationBtn);

  await waitFor(() => {
    expect(screen.getByText('New Corporation')).toBeInTheDocument();
  });
});

test('should auto-save after 30 seconds of changes', async () => {
  jest.useFakeTimers();
  render(<DiagramCanvas />);

  // Make change
  const addBtn = screen.getByTestId('add-entity-llc');
  await userEvent.click(addBtn);

  // Fast-forward 30 seconds
  act(() => {
    jest.advanceTimersByTime(30000);
  });

  await waitFor(() => {
    expect(screen.getByText(/Saved/i)).toBeInTheDocument();
  });

  jest.useRealTimers();
});
```

---

## Performance Considerations

1. **Zustand Store:**
   - Use shallow equality for selectors
   - Avoid re-renders with proper selector usage
   - Example: `const nodes = useDiagramState(state => state.nodes, shallow)`

2. **Auto-Save:**
   - Debounce saves to avoid excessive writes
   - Only save when truly dirty
   - Consider compression for large diagrams

3. **Entity Palette:**
   - Memoize entity type components
   - Use CSS transforms for hover effects (not re-renders)

---

## File Structure

```
src/
â”œâ”€â”€ components/
â”‚   â””â”€â”€ Canvas/
â”‚       â”œâ”€â”€ DiagramCanvas.tsx        # âœ… Exists â†’ UPDATE
â”‚       â”œâ”€â”€ EntityNode.tsx           # âœ… Exists
â”‚       â”œâ”€â”€ ToolPanel.tsx            # ðŸ†• CREATE
â”‚       â””â”€â”€ SaveIndicator.tsx        # ðŸ†• CREATE
â”‚
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ usePostHog.ts               # âœ… Exists
â”‚   â”œâ”€â”€ useDiagramState.ts          # ðŸ†• CREATE (Zustand)
â”‚   â””â”€â”€ useAutoSave.ts              # ðŸ†• CREATE
â”‚
â””â”€â”€ services/
    â”œâ”€â”€ layout.ts                   # âœ… Exists
    â”œâ”€â”€ storage.ts                  # âœ… Exists
    â””â”€â”€ claude.ts                   # âœ… Exists
```

---

## Implementation Order

**Day 11 (4-6 hours):**
1. Create Zustand store (`useDiagramState.ts`)
2. Migrate DiagramCanvas to use Zustand
3. Test state management works

**Day 12 (4-6 hours):**
1. Create ToolPanel component
2. Integrate entity palette in DiagramCanvas
3. Create auto-save hook
4. Add SaveIndicator component
5. Integration testing

---

## Success Criteria

âœ… **Entity Palette:**
- All 8 entity types can be added via click
- Nodes appear at viewport center
- Visual feedback on hover

âœ… **State Management:**
- Centralized state in Zustand
- LocalStorage persistence works
- Dirty flag tracking accurate

âœ… **Auto-Save:**
- Saves every 30s when dirty
- Debounces rapid changes
- Visual feedback works
- Error handling implemented

âœ… **Testing:**
- Integration tests pass
- Manual testing checklist complete
- No TypeScript errors

âœ… **Documentation:**
- Update DAY-9-10-PERFORMANCE-TESTING.md with Day 11-12 progress
- Add usage examples to README.md

---

## PostHog Events to Track

```typescript
// Entity palette
trackDiagramEvent('entity_added_manual', {
  entityType,
  method: 'palette'
});

// Auto-save
trackDiagramEvent('autosave_triggered', {
  nodeCount,
  edgeCount
});
trackDiagramEvent('autosave_success', {
  saveTimeMs
});
trackDiagramEvent('autosave_failed', {
  error
});

// State changes
trackDiagramEvent('diagram_modified', {
  action: 'add_node' | 'delete_node' | 'update_node',
  entityType
});
```

---

## Known Issues to Handle

1. **Viewport Center Calculation:**
   - Use React Flow's `project` function to convert screen coords
   - Account for zoom level and pan position

2. **Zustand Persistence:**
   - Clear old data on version mismatch
   - Handle LocalStorage quota errors

3. **Auto-Save Conflicts:**
   - Don't save during active editing
   - Pause auto-save when typing in node labels

---

## Next Steps (Week 3 - Phase 2)

After Day 11-12 completion:
- [ ] AI Generation Dialog UI
- [ ] Chat Assistant Sidebar
- [ ] Context Menu Actions
- [ ] Run full automated stress tests

---

## Commands to Run

```bash
# Development
npm run dev

# Type checking
npm run typecheck

# Tests
npm test
npm run test:coverage

# Build
npm run build
```

---

## Questions to Clarify Before Starting

1. **Entity Palette Position:** Left sidebar or top toolbar?
2. **Auto-Save Indicator:** Toast notification or persistent status?
3. **Zustand Undo/Redo:** Implement now or defer to Week 3?
4. **Entity Default Names:** "New Corporation" or prompt user immediately?

---

**Ready to begin implementation!**

Use this as your guide for Day 11-12. Implement in order, test thoroughly, and update documentation as you go.
